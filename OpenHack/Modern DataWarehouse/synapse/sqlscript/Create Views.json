{
	"name": "Create Views",
	"properties": {
		"folder": {
			"name": "Star Schema"
		},
		"content": {
			"query": "DROP VIEW dbo.DimActors;\nGO\nCREATE VIEW dbo.DimActors\nAS\nSELECT\n    ActorSK,\n    ActorId,\n    [Name] as ActorName,\n    '' as ActorGender,\n    DataSourceId\nFROM dbo.extActors;\nGO\n\nDROP VIEW dbo.DimCategories;\nGO\nCREATE VIEW dbo.DimCategories\nAS\nSELECT \n    ROW_NUMBER() OVER (ORDER BY MovieCategoryDescription desc) as MovieCategorySK,\n    MovieCategoryDescription\nFROM \n(\n    SELECT DISTINCT Genre as MovieCategoryDescription\n    FROM dbo.extMovies\n)Categories;\nGO\n\nDROP VIEW dbo.DimCustomers;\nGO\nCREATE VIEW dbo.DimCustomers\nAS\nSELECT \n    CustomerSK,\n    c.CustomerID,\n    c.LastName,\n    c.FirstName,\n    a.AddressLine1,\n    a.AddressLine2,\n    a.City,\n    a.State,\n    a.ZipCode,\n    c.PhoneNumber,\n    c.CreatedDate as RecordStartDate,\n    c.UpdatedDate as RecordEndDate,\n    c.DataSourceId\nFROM dbo.extCustomers c\nLEFT JOIN dbo.extAddresses a on c.CustomerID = a.CustomerID\n    and c.DataSourceId = a.DataSourceId\nGO\n\nDROP VIEW dbo.DimDate;\nGO\nCREATE VIEW dbo.DimDate\nAS\nSELECT \n     [DateSK]\n    ,[DateValue]\n    ,[DateYear]\n    ,[DateMonth]\n    ,[DateDay]\n    ,[DateDayOfWeek]\n    ,[DateDayOfYear]\n    ,[DateWeekOfYear]\nFROM [dbo].[extDimDate]\nGO\n\nDROP VIEW dbo.DimLocation;\nGO\nCREATE VIEW dbo.DimLocation\nAS\nSELECT \n    1 as LocationSK,\n    'Southridge' as LocationName, \n    1 as Streaming,\n    0 as Rentals,\n    1 as Sales\nUNION ALL\nSELECT\n    2 as LocationSK,\n    'VanArsdel' as LocationName, \n    0 as Streaming,\n    1 as Rentals,\n    0 as Sales\nUNION ALL\nSELECT\n    3 as LocationSK,\n    'FourthCofee' as LocationName, \n    0 as Streaming,\n    1 as Rentals,\n    0 as Sales\nGO\n\nDROP VIEW dbo.DimMovieActors;\nGO\nCREATE View dbo.DimMovieActors\nAS\nSELECT\n    MovieId,\n    ActorId,\n    DataSourceId\nFROM dbo.extMovieActors\nGO\n\nDROP VIEW dbo.DimMovies;\nGO\nCREATE VIEW dbo.DimMovies\nAS\nSELECT\n    m.MovieSK,\n    m.MovieId,\n    m.Title as MovieTitle,\n    c.MovieCategorySK,\n    r.MovieRatingSK,\n    m.Runtime as MovieRunTimeMin,\n    m.DataSourceId\nFROM dbo.extMovies m\nLEFT JOIN dbo.DimCategories c on m.Genre = c.MovieCategoryDescription\nLEFT JOIN dbo.DimRatings r on m.Rating = r.MovieRatingDescription\nGO\n\nDROP VIEW dbo.DimRatings;\nGO\nCREATE VIEW dbo.DimRatings\nAS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY Rating desc) as MovieRatingSK,\n    Rating as MovieRatingDescription\nFROM\n(\n    SELECT DISTINCT Rating\n    FROM dbo.extMovies\n\n)ratings\nGO\n\nDROP VIEW dbo.DimTime;\nGO\nCREATE VIEW dbo.DimTime\nAS\nSELECT \n    [TimeSK]\n    ,[TimeValue]\n    ,[TimeHour]\n    ,[TimeMinute]\n    ,[TimeSecond]\n    ,[TimeMinuteOfDay]\n    ,[TimeSecondOfDay]\n FROM [dbo].[extDimTime]\nGO\n\nDROP VIEW dbo.FactRentals;\nGO\nCREATE VIEW dbo.FactRentals\nAS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY TransactionId asc) as RentalSK,\n    [TransactionId],\n    c.CustomerSK,\n    facts.DataSourceId as LocationSK,\n    [MovieSK],\n    d1.DateSK as RentalDateSK,\n    d2.DateSK as ReturnDateSK,\n    DATEDIFF(day, facts.RentalDate, facts.ReturnDate) as RentalDuration,\n    [RentalCost],\n    [LateFee],\n    [RentalCost]+LateFee as [TotalCost],\n    [RewindFlag]\nFROM dbo.extRentals facts\nLEFT JOIN dbo.DimCustomers c on facts.CustomerId = c.CustomerID\n    and facts.DataSourceId = c.DataSourceId\nLEFT JOIN dbo.DimMovies m on facts.MovieId = m.MovieId\n    and facts.DataSourceId = m.DataSourceId\nLEFT JOIN dbo.DimDate d1 on facts.RentalDate = d1.DateValue\nLEFT JOIN dbo.DimDate d2 on facts.ReturnDate = d2.DateValue\nGO\n\nDROP VIEW dbo.FactSales;\nGO\nCREATE VIEW dbo.FactSales\nAS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY OrderId asc) as SalesSK,\n    [OrderId],\n    [LineNumber],\n    d1.DateSK as OrderDateSK,\n    d2.DateSK as ShipDateSK,\n    c.CustomerSK,\n    facts.DataSourceId as LocationSK,\n    m.MovieSK,\n    [Quantity],\n    [UnitCost],\n    [Quantity]*[UnitCost] as ExtendedCost\nFROM [dbo].[extDVDSales] facts\nLEFT JOIN dbo.DimCustomers c on facts.CustomerId = c.CustomerID\n    and facts.DataSourceId = c.DataSourceId\nLEFT JOIN dbo.DimMovies m on facts.MovieId = m.MovieId\n    and facts.DataSourceId = m.DataSourceId\nLEFT JOIN dbo.DimDate d1 on facts.OrderDate = d1.DateValue\nLEFT JOIN dbo.DimDate d2 on facts.ShipDate = d2.DateValue\nGO\n\nDROP VIEW dbo.FactStreaming;\nGO\nCREATE VIEW dbo.FactStreaming\nAS\nSELECT\n    ROW_NUMBER() OVER (ORDER BY TransactionId asc) as StreamingSK,\n    facts.[TransactionId],\n    c.CustomerSK,\n    m.MovieSK,\n    d1.DateSK as StreamStartDateSK,\n    t1.TimeSK as StreamStartTimeSK,\n    d2.DateSK as StreamEndDateSK,\n    t2.TimeSK as StreamEndTimeSK,\n    DATEDIFF(second, StreamStart, StreamEnd) as StreamDurationSec,\n    DATEDIFF(minute, StreamStart, StreamEnd) as StreamDurationMin\n FROM [dbo].[extStreaming] facts\nLEFT JOIN dbo.DimCustomers c on facts.CustomerId = c.CustomerID\n    and facts.DataSourceId = c.DataSourceId\nLEFT JOIN dbo.DimMovies m on facts.MovieId = m.MovieId\n    and facts.DataSourceId = m.DataSourceId\nLEFT JOIN dbo.DimDate d1 on convert(date, facts.StreamStart) = d1.DateValue\nLEFT JOIN dbo.DimDate d2 on convert(date, facts.StreamEnd) = d2.DateValue\nLEFT JOIN dbo.DimTime t1 on datepart(hour, facts.StreamStart) = t1.TimeHour\n    and datepart(minute, facts.StreamStart) = t1.TimeMinute\n    and datepart(second, facts.StreamStart) = t1.TimeSecond\nLEFT JOIN dbo.DimTime t2 on datepart(hour, facts.StreamEnd) = t2.TimeHour\n    and datepart(minute, facts.StreamEnd) = t1.TimeMinute\n    and datepart(second, facts.StreamEnd) = t1.TimeSecond",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "Southridge",
				"poolName": "Built-in"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}